{#Load sass#}
{% load compress %}
{#Import static files (images/css/js/...):#}
{% load staticfiles %}
{#Import custom made template tags and filters:#}
{% load app_dodentocht_extra_templates %}

<!DOCTYPE html>
<html>
<head lang="en">
{#This import jQuery#}
<script src="{% static "js/jQuery/jquery-1.11.1.min.js" %}"></script>
{#This import everything related to jQuery-UI (autocomplete and others)#}
    <link rel="stylesheet" type="text/css" href="{% static 'css/jQuery-UI/jquery-ui.min.css' %}" />
    <script src="{% static "js/jQuery-UI/jquery-ui.min.js" %}"></script>

{#This import css file (static)#}

    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" />

{#{% compress css %}#}
{#    <link rel="stylesheet" type="text/x-scss" href="{% static 'css/style.scss' %}" />#}
{#{% endcompress %}#}
{#Tablesorter to make table sortable via columns#}
<script src="{% static "js/tablesorter.js/jquery.tablesorter.min.js" %}"></script>
{#    Chart.js to make charts#}
<script src="{% static "js/chart.js/Chart.min.js" %}"></script>
{#    Import moment.js.js to work with ISOformat Dates#}
<script src="{% static "js/moment.js/moment.min.js" %}"></script>

<meta charset="UTF-8">

<script type="text/javascript">
    {#On document ready, load stuff#}
    $(document).ready(function(){
        $("#dodentocht_table").tablesorter({
        });

        // Define color schemes (equivalent to scss file)
        neutral_color = "rgba(214, 213, 213, 1)";
        neutral_color_opac = "rgba(214, 213, 213, 0.2)";
        your_name_color = "rgba(130, 201, 119, 1)";
        your_name_color_opac= "rgba(130, 201, 119, 0.2)";
        comp_name_color = "rgba(110, 177, 210, 1)";
        comp_name_color_opac = "rgba(110, 177, 210, 0.2)";

        colors_neutral = [neutral_color,neutral_color_opac];
        colors_your_name = [your_name_color,your_name_color_opac];
        colors_comp_name = [comp_name_color,comp_name_color_opac];

        colors = [colors_your_name,colors_comp_name];

        createRadarchart(colors);
        createLinechart(colors);

        // Do css stuff in javascript (mainly vertical centralizing)
        javascript_css();


        // Change table data in javascript
        // Slow, can be fixed by writing better prepared data into database
        // For example: don't write numbers, but write varchar to database
        javascript_table();
    });
</script>

{#    Create Radar Chart#}
<script>
    function createRadarchart(colors) {
      var data = {
            labels: {{ posts | safe }},
            datasets: [
                {
                    label: "Snelheid",
                    fillColor: colors[0][1],
                    strokeColor: colors[0][0],
                    pointColor: colors[0][0],
                    pointStrokeColor: "#fff",
                    pointHighlightFill: "#fff",
                    pointHighlightStroke: colors[0][0],
                    data: {{ speed | safe }}
                },
                {
                    label: "Gemiddelde Snelheid",
                    fillColor: colors[1][1],
                    strokeColor: colors[1][0],
                    pointColor: colors[1][0],
                    pointStrokeColor: "#fff",
                    pointHighlightFill: "#fff",
                    pointHighlightStroke: colors[1][0],
                    data: {{ speed_comp | safe }}
                }
            ]

        };

        var options = {
            {#                Go from unix millisecond value back to string, using moment.js.js#}
            multiTooltipTemplate: "<%=value + ' km/u'%>"
        };

        var ctx = document.getElementById("radar_chart").getContext("2d");
        var myLineChart = new Chart(ctx).Radar(data,options);
    }
</script>

{#    Create Line Chart#}
<script>
    function createLinechart(colors) {

        var time_graph = {{ time_graph | safe }};
        var time_graph_comp = {{ time_graph_comp | safe }};
        var time_graph_ms = [];
        var time_graph_comp_ms = [];
        {#            Count how many posts where not attained by walker#}
        {#            2015 ( = unix 1420066800) because this was datetime chosen in django code to indicate that walker did not reach post#}
        count_2015 = 0;
        count_2015_comp = 0;

        for (i = 0; i < time_graph.length; i++) {
            {#                Create moment.js.js object, then convert to unix (milliseconds since 1970)#}
            {#                Graph can be built with numbers.#}
            {#                Afterwards reconversion to date string using moment.js.js#}
            time_graph_ms[i] = moment(time_graph[i]).unix();
            time_graph_comp_ms[i] = moment(time_graph_comp[i]).unix();
            if (time_graph_ms[i] >= 1420066800) {
                count_2015 = count_2015 + 1;
            }
                        if (time_graph_comp_ms[i] >= 1420066800) {
                count_2015_comp = count_2015_comp + 1;
            }
        }

        // Remove data points where participant had abandoned race
        time_graph_ms = time_graph_ms.splice(0,time_graph_ms.length - count_2015);

        // Remove data points where participant had abandoned race
        time_graph_comp_ms = time_graph_comp_ms.splice(0,time_graph_comp_ms.length - count_2015_comp);

        var data = {
            labels: {{ posts | safe }},
            datasets: [
                {
                    label: "Tijd",
                    fillColor: colors[0][1],
                    strokeColor: colors[0][0],
                    pointColor: colors[0][0],
                    pointStrokeColor: "#fff",
                    pointHighlightFill: "#fff",
                    pointHighlightStroke: colors[0][0],
                    data: time_graph_ms
                },
                {
                    label: "Gemiddelde tijd",
                    fillColor: colors[1][1],
                    strokeColor: colors[1][0],
                    pointColor: colors[1][0],
                    pointStrokeColor: "#fff",
                    pointHighlightFill: "#fff",
                    pointHighlightStroke: colors[1][0],
                    data: time_graph_comp_ms
                }
            ]
        };

        var options = {
            //Go from unix millisecond value back to string, using moment.js

            // On the scale (y-axis), round to hours (startOf function - see moment.js for documentation)
            scaleLabel: "<%=moment.unix(value).startOf('hour').format('HH:mm')%>",

            // On the tooltips, give hours and minutes
            multiTooltipTemplate: "<%=moment.unix(value).format('HH:mm')%>"
        };
        var ctx = document.getElementById("line_chart").getContext("2d");
        var myLineChart = new Chart(ctx).Line(data,options);
    }
</script>

{#    Centralize div's vertically#}
<script>
    function javascript_css() {
        // Centralize table vertically
        $('#table_wrapper').css('margin-top', ($('#wrapper').height() - $('#table_wrapper').outerHeight())/2);

        // Create equal margin between div's inside wrapper
        $('#radar_chart_wrapper').css('margin-left', $('#radar_chart_wrapper').width()/10);
        $('#radar_chart_wrapper').css('margin-right', $('#radar_chart_wrapper').width()/10);

        // Set classes of table rows (for correct colors and hover specs)
        $('#dodentocht_table tbody tr').each(function() {
            // First column posts (neutral)
            $($(this)).find("td:eq(0),td:eq(1)").addClass("neutral");

            // Next two columns (your_name)
            $($(this)).find("td:eq(2),td:eq(3)").addClass("your_name");

            // Next two columns (comp_name)
            $($(this)).find("td:eq(4),td:eq(5)").addClass("comp_name");
        });
    }

</script>

{#Change data points in table using javascript#}
<script>
    function javascript_table() {
        // Check if hour is 00:00, change to -
        $('#dodentocht_table tbody td').each(function() {
            if ($($(this)).html() == "00:00" || $($(this)).html() == "0.0") {
                $($(this)).html("-");
            }
        });


        // Check if speed is 0.0, change to -
    }

</script>


{#Initiate autocomplete for input box#}
    <script>
  $(function() {
    var names = {{ names | safe }}
    $( "#id_your_name" ).autocomplete({
      source: names
    });
  });
  </script>
<title>{{ header | get_at_index:1 }}</title>

</head>
<body>
<div>{{ header }} </div>

{#Compare input box#}
<form action="/your-name/compare/" method="post">
    {% csrf_token %}
    {{ form_comp_other }}
    <input type="submit" value="Submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/>
</form>

<div id="wrapper" class="container">
    <div id="table_wrapper" class="left">
        <table cellspacing='0' id="dodentocht_table" class="tablesorter">
            {#            Make table headers#}
            <thead>
            <tr>
                <th id ="th_posts" colspan="2" style="visibility: hidden; background-color: transparent; opacity: 0;"></th>
                <th id ="th_posts" class= "your_name" colspan="2">{{ header |get_at_index:1 }}</th>
                <th id ="th_posts" class= "comp_name" colspan="2">{{ header |get_at_index:3 }}</th>

            </tr>
            <tr>
                <th id ="th_posts" class= "neutral">Post</th>
                <th id ="th_km" class= "neutral">Km</th>
                <th id ="th_time" class= "your_name">Tijd</th>
                <th id ="th_speed" class= "your_name">Snelheid</th>
                <th id ="th_time" class= "comp_name">Tijd</th>
                <th id ="th_speed" class= "comp_name">Snelheid</th>
            </tr>
            </thead>
            {#            Fill rest of table with data#}
            <tbody>
            {#    Loop over columns #}
            {% for values in table %}
                <tr id="{{ "tr_" }}{{ forloop.counter }}">
                    {% for value in values %}
                        <td id="{{ "td_" }}{{ table | get_at_index:forloop.counter }}{{ "_team_" }}{{ forloop.parentloop.counter }}">{{ value }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="radar_chart_wrapper" class="center">
        {#Radar Chart#}
        <canvas id="radar_chart" width ="400" height="400"></canvas>
    </div>
    <div id="line_chart_wrapper" class="right">
        {#Line Chart#}
        <canvas id="line_chart" width ="400" height="400"></canvas>
    </div>
    {#To make sure div wrapper has correct height#}
    <div style='clear: both'></div>
</div>

</body>
</html>

